---
title: 浏览器架构
date: 2021-12-24 16:37:02
tags: javascript基础
keywords: 浏览器
categories: 笔记
---
Chrome架构： 仅仅打开了一个页面，为什么有四个进程？

进程和线程

线程：
●  线程是最小的执行单元。
●  线程是不能单独存在的，它是由进程来启动和管理的

进程：
● 一个进程就是一个程序的运行实例。启动一个程序的时候，操作系统会为该程序创建一块内存，用来存放代码、运行中的数据和一个执行任务的主线程，这样的运行环境叫进程。

线程是依附于进程的，而进程中使用多线程并行处理能提升运算速率。

进程和线程之间的关系特点：
1.  进程中的任一线程执行出错，都会导致整个进程崩溃。
2.  线程之间共享进程中的数据。
    线程之间可以对进程的公共数据进行读写操作。
3.  当一个进程关闭之后，操作系统会回首进程所占用的内存。
    当一个进程退出时，操作系统会回收改进程所申请的所有资源；即使其中任一线程因为操作不当导致内存泄漏，当进程退出时，这些内存也会被正确回收。
4.  进程之间的内容相互隔离。
    进程隔离是为保护操作系统中进程互不干扰的技术，每一个进程只能访问自己占有的数据，也就避免出现进程A写入数据到进程B的情况。正是因为进程之间的数据是杨哥隔离的，所以一个进程如果崩溃了，或者挂起了，是不会影响到其他进程的。如果进程之间需要进行数据的通信，这时候，就需要使用用于进程间通信（IPC）的机制了。
    单进程浏览器架构
    单进程浏览器是指浏览器的所有功能模块都是运行在哟个进程里，这些模块包含了网络、插件、JavaScript运行环境、渲染引擎、和页面等。

单进程架构问题：不稳定、不流畅、不安全

问题1: 不稳定
早期浏览器需要借助于插件来实现诸如Web视频、Web游戏等各种强大的功能，但是插件是最容易出问题的模块，并且还运行在浏览器进程中，所以一个插件的意外崩溃会引起整个浏览器的崩溃。
除了插件之外，渲染引擎模块也是不稳定的，通常一些复杂的JavaSctipt代码就有肯呢个引起渲染引擎模块的崩溃。和插件一样，渲染引擎的崩溃也会导致整个浏览器的崩溃。

问题2: 不流畅
从“单进程浏览器架构示意图”可以看出，所有页面的渲染模块、JavaScript执行环境以及插件都是运行在同一个线程中，这就意味着同一时刻只能有一个模块可以执行。
除了脚本或者插件会让单进程浏览器变卡顿外，页面的内存泄漏也是单进程变慢的一个重要原因。通常浏览器的内核都是非常复杂的，运行一个复杂点的页面再关闭页面，会存在内存不能完全回收的情况，这样导致的问题是使用时间越长，内存占用越高，浏览器会变慢。

问题3：不安全
通过插件可以获取到操作系统的任意资源，如果是个恶意插件，那么它就可以释放病毒、窃取你的账号密码，引发安全问题。

多进程浏览器时代

早期的多进程架构：

从上图可见，Chrome的页面是运行在单独的渲染进程中的，同时页面里的插件也是运行在单独的插件进程中，而进程之间是通过IPC 机制进行通信（如图中虚线部分）。

如何解决不稳定的问题。 由于进程是互相隔离的，所以当一个页面或者插件崩溃时，影响到的仅仅是当前的页面进程或者插件进程，不会影响到浏览器和其他页面。

如何解决运行不流畅的问题。 javaScript也是运行在渲染进程中的，所以即使JavaScript阻塞了渲染进程，影响到的也只是当前的渲染页面，而不会影响到浏览器和其他页面，因为其他页面的脚本是运行在他们自己的渲染进程中的。
对于内存泄漏的解决方案：因为当关闭一个页面时，整个渲染进程也会被关闭，之后该进程所占用的内存都会被系统回收，这样就轻松解决了浏览器页面的内存泄漏的问题。

如何解决安全问题。多进程的架构可以使用安全沙箱，Chorme把插件进程和渲染进程锁在沙箱里，这样即使在渲染进程或者插件进程执行了恶意程序，恶意程序也无法突破沙箱获取系统权限。

目前的多进程架构
从图中可以看出目前的Chrome浏览器包括：一个浏览器（Brower）主进程，一个GPU进程，一个网络进程，多个渲染进程和多个插件进程。
● 浏览器进程：主要负责页面显示，用户交互子进程管理，同时提供存储等功能。
● 渲染进程： 核心任务是将HTML、CSS和JavaScript转换为用户可以与之交互的网页。排版引擎Blink和JavaScript引擎都运行在该进程中，默认情况下Chrome会为每个Tab标签创建一个渲染进程。渲染进程都运行在沙箱模式下。
● GPU进程：GPU使用的初衷是实现3D CSS效果，随后网页，Chrome的UI界面都是采用GPU来绘制，是的GPU成为浏览器的普遍需求。所以Chrome在多进程架构上引入了GPU进程。
● 网络进程：主要负责页面的网络资源，之前作为一个模块运行在浏览器进程中，现在独立出来成为一个单独的进程。
● 插件进程：主要是负责插件的运行，因插件易崩溃，所以需要通过插件进程来隔离，以保证插件进程崩溃不会对浏览器和页面造成影响。

多进程模型提升了浏览器的稳定性、流畅性和安全性，但同样不可避免地带来了一些问题：
● 更高的资源占用。因为每个进程都会包含公共基础结构的副本如（JavaScript的运行环境），这意味着浏览器会消耗更多的内存资源。
● 更复杂的体系架构。浏览器各模块之间耦合性高、扩展性差等问题会导致现在的架构很难适应新的需求。

未来面向服务的架构
在 2016 年，Chrome 官方团队使用“面向服务的架构”（Services Oriented Architecture，简称 SOA）的思想设计了新的 Chrome 架构。也就是说 Chrome 整体架构会朝向现代操作系统所采用的“面向服务的架构” 方向发展，原来的各种模块会被重构成独立的服务（Service），每个服务（Service）都可以在独立的进程中运行，访问服务（Service）必须使用定义好的接口，通过 IPC 来通信，从而构建一个更内聚、松耦合、易于维护和扩展的系统，更好实现 Chrome 简单、稳定、高速、安全的目标。
Chrome 最终要把 UI、数据库、文件、设备、网络等模块重构为基础服务，类似操作系统底层服务，下面是 Chrome“面向服务的架构”的进程模型图：

同时 Chrome 还提供灵活的弹性架构，在强大性能设备上会以多进程的方式运行基础服务，但是如果在资源受限的设备上（如下图），Chrome 会将很多服务整合到一个进程中，从而节省内存占用。
